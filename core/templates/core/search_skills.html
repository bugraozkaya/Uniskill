{% extends 'core/base.html' %}

{% block content %}
<div class="row g-4">
    
    <div class="col-lg-3">
        <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 100px;">
            <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                <h5 class="fw-bold d-flex align-items-center">
                    <i class="fas fa-sliders-h me-2 text-primary"></i> Filters
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="GET" action="{% url 'search_skills' %}" id="filter-form">
                    
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted text-uppercase">Search</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" name="q" id="search-input" class="form-control bg-light border-start-0" placeholder="Skill, user, keyword..." value="{{ query|default:'' }}" autocomplete="off">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted text-uppercase">Category</label>
                        <select name="category" class="form-select bg-light border-0 filter-trigger">
                            <option value="all">All Categories</option>
                            {% for code, name in categories %}
                                <option value="{{ code }}" {% if selected_category == code %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted text-uppercase">Minimum Rating</label>
                        <div class="d-flex gap-2">
                            {% for i in "43" %}
                            <div class="form-check">
                                <input class="form-check-input filter-trigger" type="radio" name="rating" value="{{ i }}" id="rating{{ i }}" {% if selected_rating == i %}checked{% endif %}>
                                <label class="form-check-label" for="rating{{ i }}">
                                    {{ i }}+ <i class="fas fa-star text-warning"></i>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted text-uppercase">Sort By</label>
                        <select name="sort" class="form-select bg-light border-0 filter-trigger">
                            <option value="newest" {% if selected_sort == 'newest' %}selected{% endif %}>Newest First</option>
                            <option value="rating" {% if selected_sort == 'rating' %}selected{% endif %}>Highest Rated</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary fw-bold py-2 rounded-3 shadow-sm">Apply Filters</button>
                        <a href="{% url 'search_skills' %}" class="btn btn-light text-muted py-2 rounded-3">Clear</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold mb-0">
                Found Skills 
                <span class="text-muted fw-normal" id="result-count"></span>
            </h4>
            
            <div id="loading-spinner" class="spinner-border text-primary spinner-border-sm d-none" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div id="results-container">
            {% include 'core/skill_list_partial.html' %}
        </div>
    </div>
</div>

<style>
    .hover-up:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important;
    }
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('results-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const filterForm = document.getElementById('filter-form');
        
        // Filtre tetikleyicileri (Select ve Radio butonları)
        const filterTriggers = document.querySelectorAll('.filter-trigger');

        let timeout = null;

        // Arama Fonksiyonu
        function fetchResults() {
            // 1. Form verilerini al
            const formData = new FormData(filterForm);
            
            // Parametreleri URL formatına çevir
            const params = new URLSearchParams(formData);
            params.append('is_ajax', '1'); // Django'ya bunun AJAX olduğunu söyle

            // 2. Yükleniyor spinner'ını göster ve opaklığı düşür
            resultsContainer.style.opacity = '0.5';
            loadingSpinner.classList.remove('d-none');

            // 3. İsteği Gönder (Fetch API)
            fetch(`{% url 'search_skills' %}?${params.toString()}`)
                .then(response => response.text())
                .then(html => {
                    // 4. Gelen HTML'i kutuya koy
                    resultsContainer.innerHTML = html;
                    
                    // Görünümü düzelt
                    resultsContainer.style.opacity = '1';
                    loadingSpinner.classList.add('d-none');
                    
                    // URL'i güncelle (Sayfa yenilenirse aynı arama kalsın diye)
                    const newUrl = `${window.location.pathname}?${params.toString().replace('&is_ajax=1', '')}`;
                    window.history.pushState({}, '', newUrl);
                })
                .catch(error => console.error('Error:', error));
        }

        // Klavye tuşuna basınca çalış (300ms gecikmeli - Debounce)
        searchInput.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(fetchResults, 300);
        });

        // Filtrelerden biri değişince (Category, Sort, Rating) otomatik çalış
        filterTriggers.forEach(element => {
            element.addEventListener('change', function() {
                fetchResults();
            });
        });
    });
</script>
{% endblock %}